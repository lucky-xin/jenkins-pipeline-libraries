# 使用多架构支持的 JRE 作为基础镜像（arm64/amd64 均可）
FROM eclipse-temurin:21-jre-jammy

# 设置维护者信息
LABEL maintainer="chaoxin.lu"
LABEL description="Multi-arch SonarQube Scanner CLI with Node.js 20.11.0 and environment variable support"

# 安装必要工具并下载 SonarScanner CLI（不自带JRE版本）
ENV SONAR_SCANNER_VERSION=7.2.0.5079 \
    SONAR_SCANNER_HOME=/opt/sonar-scanner \
    NODE_VERSION=20.11.0 \
    NODE_HOME=/opt/node

RUN set -eux; \
    sed -i 's|http://ports.ubuntu.com/ubuntu-ports|http://mirrors.aliyun.com/ubuntu-ports|g' /etc/apt/sources.list; \
    apt-get update; \
    apt-get install -y --no-install-recommends curl unzip ca-certificates xz-utils; \
    rm -rf /var/lib/apt/lists/*; \
    \
    # 安装 SonarScanner CLI \
    mkdir -p "$SONAR_SCANNER_HOME"; \
    curl -fsSL "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux-aarch64.zip" -o /tmp/sonar-scanner.zip; \
    unzip -q /tmp/sonar-scanner.zip -d /opt; \
    SC_DIR=$(find /opt -maxdepth 1 -type d -name "sonar-scanner-*" | head -n1); \
    mkdir -p "$SONAR_SCANNER_HOME"; \
    mv "$SC_DIR"/* "$SONAR_SCANNER_HOME"/; \
    rmdir "$SC_DIR"; \
    chmod +x "$SONAR_SCANNER_HOME"/bin/* || true; \
    rm -f /tmp/sonar-scanner.zip; \
    ln -s "$SONAR_SCANNER_HOME/bin/sonar-scanner" /usr/local/bin/sonar-scanner; \
    ln -s "$SONAR_SCANNER_HOME/bin/sonar-scanner-debug" /usr/local/bin/sonar-scanner-debug; \
    \
    # 安装 Node.js \
    mkdir -p "$NODE_HOME"; \
    curl -fsSL "https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-arm64.tar.xz" -o /tmp/node.tar.xz; \
    tar -xJf /tmp/node.tar.xz -C /opt; \
    mv "/opt/node-v${NODE_VERSION}-linux-arm64"/* "$NODE_HOME"/; \
    rmdir "/opt/node-v${NODE_VERSION}-linux-arm64"; \
    chmod +x "$NODE_HOME"/bin/* || true; \
    rm -f /tmp/node.tar.xz; \
    ln -s "$NODE_HOME/bin/node" /usr/local/bin/node; \
    ln -s "$NODE_HOME/bin/npm" /usr/local/bin/npm; \
    ln -s "$NODE_HOME/bin/npx" /usr/local/bin/npx; \
    \
    # 清理 \
    apt-get purge -y --auto-remove curl unzip xz-utils; \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/* /tmp/* /var/tmp/*

ENV PATH="$NODE_HOME/bin:$SONAR_SCANNER_HOME/bin:${PATH}"

WORKDIR /usr/src